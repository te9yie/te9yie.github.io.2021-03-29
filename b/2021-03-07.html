<!DOCTYPE html><html><head><title>2021-03-07 | te9yie</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="google-site-verification" content="iMWdKZ02K2Yzj9AtOP4cl-40F5DJp-YJLQDzv9vQgMk"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/509606b329852c74360b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/509606b329852c74360b.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-1f0b73d383aed819e4f2.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.3a16fc34825ffc7ba561.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-be08fdd24fededd721c6.js" as="script"/><link rel="preload" href="/_next/static/chunks/7ac61503aba6d10b58e3c266d97d99b7b5b3721a.c1b518faff21babf1a9f.js" as="script"/><link rel="preload" href="/_next/static/chunks/5f8a2089eac11fe3b358516a6b612033195d4834.64ceb811d7eabbf018a0.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/b/%5Bid%5D-eaf8ebe7ceed852553b5.js" as="script"/></head><body><div id="__next"><header><nav><ul><li><a id="site-name" href="/"><h1>te9yie</h1></a></li><li><a href="/b">Blog</a></li><li><a href="/w">Wiki</a></li><li><a href="/search">Search</a></li></ul></nav><h2>2021-03-07</h2></header><article><p><a class="wiki-link" href="/w/Rust">Rust</a>から<a class="wiki-link" href="/w/WebAssembly">WebAssembly</a>を作ってみる。</p><p><a href="https://rustwasm.github.io/docs/wasm-bindgen/examples/hello-world.html">Hello, World! - The <code>wasm-bindgen</code> Guide</a>を参考にやってみたんだけど、色々上手く動かなかった。</p><pre><code class="language-bash">$ cargo new hello-wasm --lib
$ cd hello-wasm
$ yarn init -y
$ yarn add -D @wasm-tool/wasm-pack-plugin text-encoding html-webpack-plugin webpack webpack-cli webpack-dev-server
$ code . # サンプルのコードを参考に色々書く
$ yarn build</code></pre><p>ここでエラー</p><pre><code class="language-bash">yarn run v1.22.10
$ webpack
🧐  Checking for wasm-pack...

ℹ️  Installing wasm-pack 

[webpack-cli] Error: Rust compilation.
    at ChildProcess.p.on.code (/home/i/w/hello-wasm/node_modules/@wasm-tool/wasm-pack-plugin/plugin.js:221:16)
    at ChildProcess.emit (events.js:198:13)
    at maybeClose (internal/child_process.js:982:16)
    at Socket.stream.socket.on (internal/child_process.js:389:11)
    at Socket.emit (events.js:198:13)
    at Pipe._handle.close (net.js:607:12)
error Command failed with exit code 2.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.</code></pre><p><code>cargo build</code>は問題なくて<code>$(npm bin)/webpack</code>したらエラーになる。<br/><code>wasm-pack-plugin</code>ってのでコケてそうだったので、<a href="https://github.com/wasm-tool/wasm-pack-plugin">wasm-tool/wasm-pack-plugin: webpack plugin for Rust</a>を見に行ったら、<code>wasm-pack</code>を入れろって書いてあった。よく見るとメッセージにも<code>Installing wasm-pack</code>って出てた。</p><pre><code class="language-bash">$ cargo install wasm-pack
$ yarn build</code></pre><p>またエラー</p><pre><code class="language-bash">yarn run v1.22.10
$ webpack
🧐  Checking for wasm-pack...

✅  wasm-pack is installed at /home/i/.cargo/bin/wasm-pack. 

ℹ️  Compiling your crate in development mode...

[INFO]: Checking for the Wasm target...
[INFO]: Compiling to Wasm...
   Compiling cfg-if v1.0.0
   Compiling wasm-bindgen v0.2.71
   Compiling hello-wasm v0.1.0 (/home/i/w/hello-wasm)
    Finished dev [unoptimized + debuginfo] target(s) in 0.83s
:-) [WARN]: origin crate has no README
[INFO]: Installing wasm-bindgen...
[INFO]: Optional fields missing from Cargo.toml: &#x27;description&#x27;, &#x27;repository&#x27;, and &#x27;license&#x27;. These are not necessary, but recommended
[INFO]: :-) Done in 1.06s
[INFO]: :-) Your wasm pkg is ready to publish at /home/i/w/hello-wasm/pkg.
✅  Your crate has been correctly compiled

asset vendors-node_modules_text-encoding_index_js.index.js 623 KiB [emitted] (id hint: vendors)
asset index.js 13.3 KiB [emitted] (name: main)
asset pkg_index_js.index.js 7.28 KiB [emitted]
asset index.html 232 bytes [emitted]
runtime modules 7.32 KiB 11 modules
cacheable modules 692 KiB
  modules by path ./pkg/ 74.7 KiB
    ./pkg/index.js 71 bytes [built] [code generated]
    ./pkg/index_bg.js 3.25 KiB [built] [code generated]
    ./pkg/index_bg.wasm 71.4 KiB [built] [code generated] [1 error]
  modules by path ./node_modules/text-encoding/ 617 KiB
    ./node_modules/text-encoding/index.js 258 bytes [built] [code generated]
    ./node_modules/text-encoding/lib/encoding.js 99.1 KiB [built] [code generated]
    ./node_modules/text-encoding/lib/encoding-indexes.js 518 KiB [built] [code generated]
  ./index.js 88 bytes [built] [code generated]

ERROR in ./pkg/index_bg.wasm 1:0
Module parse failed: Unexpected character &#x27;&#x27; (1:0)
The module seem to be a WebAssembly module, but module is not flagged as WebAssembly module for webpack.
BREAKING CHANGE: Since webpack 5 WebAssembly is not enabled by default and flagged as experimental feature.
You need to enable one of the WebAssembly experiments via &#x27;experiments.asyncWebAssembly: true&#x27; (based on async modules) or &#x27;experiments.syncWebAssembly: true&#x27; (like webpack 4, deprecated).
For files that transpile to WebAssembly, make sure to set the module type in the &#x27;module.rules&#x27; section of the config (e. g. &#x27;type: &quot;webassembly/async&quot;&#x27;).
(Source code omitted for this binary file)
 @ ./pkg/index.js 1:0-40
 @ ./index.js 1:13-28

webpack 5.24.3 compiled with 1 error in 1526 ms
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.</code></pre><p><code>experiments.asyncWebAssembly: true</code>にして<code>module.rules</code>を設定しろとのことなので<code>webpack.config.js</code>を修正した。</p><pre><code class="language-diff">+  experiments: {
+    asyncWebAssembly: true,
+  },
+  module: {
+    rules: [
+      {
+        test: /\.wasm/,
+        type: &quot;webassembly/async&quot;,
+      },
+    ],
+  },</code></pre><p><code>yarn build</code>が通ったので<code>yarn serve</code>してみる。エラー。</p><pre><code class="language-bash">$ yarn serve
yarn run v1.22.10
$ webpack-dev-server
internal/modules/cjs/loader.js:638
    throw err;
    ^

Error: Cannot find module &#x27;webpack-cli/bin/config-yargs&#x27;
    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:636:15)
    at Function.Module._load (internal/modules/cjs/loader.js:562:25)
    at Module.require (internal/modules/cjs/loader.js:692:17)
    at require (internal/modules/cjs/helpers.js:25:18)
    at Object.&lt;anonymous&gt; (/home/i/w/hello-wasm/node_modules/webpack-dev-server/bin/webpack-dev-server.js:65:1)
    at Module._compile (internal/modules/cjs/loader.js:778:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:789:10)
    at Module.load (internal/modules/cjs/loader.js:653:32)
    at tryModuleLoad (internal/modules/cjs/loader.js:593:12)
    at Function.Module._load (internal/modules/cjs/loader.js:585:3)
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.</code></pre><p><a href="https://iwb.jp/webpack-cli-dev-server-error-config-yargs/">webpackでWebサーバーでの確認にwebpack-dev-serverは不可 | iwb.jp</a>で、<code>webpack-cli serve</code>を使えとのことなので、修正してみる。</p><pre><code class="language-diff">-    &quot;serve&quot;: &quot;webpack-dev-server&quot;
+    &quot;serve&quot;: &quot;webpack-cli serve --open --mode development&quot;</code></pre><p>エラーなく動いた。が、何も起きない。どうなってんだ？と思ってデベロッパーツールを見たらエラーが出てた。</p><pre><code>TypeError: Cannot read property &#x27;__wbindgen_malloc&#x27; of undefined
    at Module.greet (index_bg.js:115)
    at eval (index.js:4)</code></pre><p>…無理。もう分かんない。<br/>そもそもサンプル動くんかよ。と思って</p><p><a href="https://github.com/rustwasm/wasm-bindgen/tree/master/examples/hello_world">https://github.com/rustwasm/wasm-bindgen/tree/master/examples/hello_world</a></p><p>を試したら動いた。<br/>何が違うんだと思ってよく見比べると<code>package.json</code>が違った。</p><pre><code class="language-diff">-    &quot;html-webpack-plugin&quot;: &quot;^5.2.0&quot;,
-    &quot;webpack&quot;: &quot;^5.24.3&quot;,
-    &quot;webpack-cli&quot;: &quot;^4.5.0&quot;,
-    &quot;webpack-dev-server&quot;: &quot;^3.11.2&quot;
+    &quot;html-webpack-plugin&quot;: &quot;^3.2.0&quot;,
+    &quot;webpack&quot;: &quot;^4.29.4&quot;,
+    &quot;webpack-cli&quot;: &quot;^3.1.1&quot;,
+    &quot;webpack-dev-server&quot;: &quot;^3.1.0&quot;</code></pre><p>さっきからエラーの内容も大体<a class="wiki-link" href="/w/webpack">webpack</a>のバージョンが4じゃなくて5だから出てる雰囲気を醸し出していた。なんでも最新じゃだめなんだねぇ。</p><p>とりあえず<a class="wiki-link" href="/w/webpack">webpack</a>あたりのバージョンを4にしてみる。</p><pre><code class="language-diff">-    &quot;html-webpack-plugin&quot;: &quot;^5.2.0&quot;,
-    &quot;webpack&quot;: &quot;^5.24.3&quot;,
+    &quot;html-webpack-plugin&quot;: &quot;^4.0.0&quot;,
+    &quot;webpack&quot;: &quot;^4.0.0&quot;,</code></pre><p>動いた。</p><h3>まとめ</h3><p>パッケージのバージョン合わせるの大事！！！</p></article><footer>© <!-- -->2021<!-- --> <!-- -->te9yie</footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"id":"2021-03-07","content":"[[Rust]]から[[WebAssembly]]を作ってみる。\n\n[Hello, World! - The `wasm-bindgen` Guide](https://rustwasm.github.io/docs/wasm-bindgen/examples/hello-world.html)を参考にやってみたんだけど、色々上手く動かなかった。\n\n```bash\n$ cargo new hello-wasm --lib\n$ cd hello-wasm\n$ yarn init -y\n$ yarn add -D @wasm-tool/wasm-pack-plugin text-encoding html-webpack-plugin webpack webpack-cli webpack-dev-server\n$ code . # サンプルのコードを参考に色々書く\n$ yarn build\n```\n\nここでエラー\n\n```bash\nyarn run v1.22.10\n$ webpack\n🧐  Checking for wasm-pack...\n\nℹ️  Installing wasm-pack \n\n[webpack-cli] Error: Rust compilation.\n    at ChildProcess.p.on.code (/home/i/w/hello-wasm/node_modules/@wasm-tool/wasm-pack-plugin/plugin.js:221:16)\n    at ChildProcess.emit (events.js:198:13)\n    at maybeClose (internal/child_process.js:982:16)\n    at Socket.stream.socket.on (internal/child_process.js:389:11)\n    at Socket.emit (events.js:198:13)\n    at Pipe._handle.close (net.js:607:12)\nerror Command failed with exit code 2.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\n```\n\n`cargo build`は問題なくて`$(npm bin)/webpack`したらエラーになる。\n`wasm-pack-plugin`ってのでコケてそうだったので、[wasm-tool/wasm-pack-plugin: webpack plugin for Rust](https://github.com/wasm-tool/wasm-pack-plugin)を見に行ったら、`wasm-pack`を入れろって書いてあった。よく見るとメッセージにも`Installing wasm-pack`って出てた。\n\n```bash\n$ cargo install wasm-pack\n$ yarn build\n```\n\nまたエラー\n\n```bash\nyarn run v1.22.10\n$ webpack\n🧐  Checking for wasm-pack...\n\n✅  wasm-pack is installed at /home/i/.cargo/bin/wasm-pack. \n\nℹ️  Compiling your crate in development mode...\n\n[INFO]: Checking for the Wasm target...\n[INFO]: Compiling to Wasm...\n   Compiling cfg-if v1.0.0\n   Compiling wasm-bindgen v0.2.71\n   Compiling hello-wasm v0.1.0 (/home/i/w/hello-wasm)\n    Finished dev [unoptimized + debuginfo] target(s) in 0.83s\n:-) [WARN]: origin crate has no README\n[INFO]: Installing wasm-bindgen...\n[INFO]: Optional fields missing from Cargo.toml: 'description', 'repository', and 'license'. These are not necessary, but recommended\n[INFO]: :-) Done in 1.06s\n[INFO]: :-) Your wasm pkg is ready to publish at /home/i/w/hello-wasm/pkg.\n✅  Your crate has been correctly compiled\n\nasset vendors-node_modules_text-encoding_index_js.index.js 623 KiB [emitted] (id hint: vendors)\nasset index.js 13.3 KiB [emitted] (name: main)\nasset pkg_index_js.index.js 7.28 KiB [emitted]\nasset index.html 232 bytes [emitted]\nruntime modules 7.32 KiB 11 modules\ncacheable modules 692 KiB\n  modules by path ./pkg/ 74.7 KiB\n    ./pkg/index.js 71 bytes [built] [code generated]\n    ./pkg/index_bg.js 3.25 KiB [built] [code generated]\n    ./pkg/index_bg.wasm 71.4 KiB [built] [code generated] [1 error]\n  modules by path ./node_modules/text-encoding/ 617 KiB\n    ./node_modules/text-encoding/index.js 258 bytes [built] [code generated]\n    ./node_modules/text-encoding/lib/encoding.js 99.1 KiB [built] [code generated]\n    ./node_modules/text-encoding/lib/encoding-indexes.js 518 KiB [built] [code generated]\n  ./index.js 88 bytes [built] [code generated]\n\nERROR in ./pkg/index_bg.wasm 1:0\nModule parse failed: Unexpected character '' (1:0)\nThe module seem to be a WebAssembly module, but module is not flagged as WebAssembly module for webpack.\nBREAKING CHANGE: Since webpack 5 WebAssembly is not enabled by default and flagged as experimental feature.\nYou need to enable one of the WebAssembly experiments via 'experiments.asyncWebAssembly: true' (based on async modules) or 'experiments.syncWebAssembly: true' (like webpack 4, deprecated).\nFor files that transpile to WebAssembly, make sure to set the module type in the 'module.rules' section of the config (e. g. 'type: \"webassembly/async\"').\n(Source code omitted for this binary file)\n @ ./pkg/index.js 1:0-40\n @ ./index.js 1:13-28\n\nwebpack 5.24.3 compiled with 1 error in 1526 ms\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\n```\n\n`experiments.asyncWebAssembly: true`にして`module.rules`を設定しろとのことなので`webpack.config.js`を修正した。\n\n```diff\n+  experiments: {\n+    asyncWebAssembly: true,\n+  },\n+  module: {\n+    rules: [\n+      {\n+        test: /\\.wasm/,\n+        type: \"webassembly/async\",\n+      },\n+    ],\n+  },\n```\n\n`yarn build`が通ったので`yarn serve`してみる。エラー。\n\n```bash\n$ yarn serve\nyarn run v1.22.10\n$ webpack-dev-server\ninternal/modules/cjs/loader.js:638\n    throw err;\n    ^\n\nError: Cannot find module 'webpack-cli/bin/config-yargs'\n    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:636:15)\n    at Function.Module._load (internal/modules/cjs/loader.js:562:25)\n    at Module.require (internal/modules/cjs/loader.js:692:17)\n    at require (internal/modules/cjs/helpers.js:25:18)\n    at Object.\u003canonymous\u003e (/home/i/w/hello-wasm/node_modules/webpack-dev-server/bin/webpack-dev-server.js:65:1)\n    at Module._compile (internal/modules/cjs/loader.js:778:30)\n    at Object.Module._extensions..js (internal/modules/cjs/loader.js:789:10)\n    at Module.load (internal/modules/cjs/loader.js:653:32)\n    at tryModuleLoad (internal/modules/cjs/loader.js:593:12)\n    at Function.Module._load (internal/modules/cjs/loader.js:585:3)\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\n```\n\n[webpackでWebサーバーでの確認にwebpack-dev-serverは不可 | iwb.jp](https://iwb.jp/webpack-cli-dev-server-error-config-yargs/)で、`webpack-cli serve`を使えとのことなので、修正してみる。\n\n```diff\n-    \"serve\": \"webpack-dev-server\"\n+    \"serve\": \"webpack-cli serve --open --mode development\"\n```\n\nエラーなく動いた。が、何も起きない。どうなってんだ？と思ってデベロッパーツールを見たらエラーが出てた。\n\n```\nTypeError: Cannot read property '__wbindgen_malloc' of undefined\n    at Module.greet (index_bg.js:115)\n    at eval (index.js:4)\n```\n\n…無理。もう分かんない。\nそもそもサンプル動くんかよ。と思って\n\nhttps://github.com/rustwasm/wasm-bindgen/tree/master/examples/hello_world\n\nを試したら動いた。\n何が違うんだと思ってよく見比べると`package.json`が違った。\n\n```diff\n-    \"html-webpack-plugin\": \"^5.2.0\",\n-    \"webpack\": \"^5.24.3\",\n-    \"webpack-cli\": \"^4.5.0\",\n-    \"webpack-dev-server\": \"^3.11.2\"\n+    \"html-webpack-plugin\": \"^3.2.0\",\n+    \"webpack\": \"^4.29.4\",\n+    \"webpack-cli\": \"^3.1.1\",\n+    \"webpack-dev-server\": \"^3.1.0\"\n```\n\nさっきからエラーの内容も大体[[webpack]]のバージョンが4じゃなくて5だから出てる雰囲気を醸し出していた。なんでも最新じゃだめなんだねぇ。\n\nとりあえず[[webpack]]あたりのバージョンを4にしてみる。\n\n```diff\n-    \"html-webpack-plugin\": \"^5.2.0\",\n-    \"webpack\": \"^5.24.3\",\n+    \"html-webpack-plugin\": \"^4.0.0\",\n+    \"webpack\": \"^4.0.0\",\n```\n\n動いた。\n\n### まとめ\n\nパッケージのバージョン合わせるの大事！！！\n"}},"__N_SSG":true},"page":"/b/[id]","query":{"id":"2021-03-07"},"buildId":"6ITGa_4BtWY_kkzQctGtQ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-4f4acd756cef4fe6da1b.js"></script><script src="/_next/static/chunks/main-1f0b73d383aed819e4f2.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" async=""></script><script src="/_next/static/chunks/commons.3a16fc34825ffc7ba561.js" async=""></script><script src="/_next/static/chunks/pages/_app-be08fdd24fededd721c6.js" async=""></script><script src="/_next/static/chunks/7ac61503aba6d10b58e3c266d97d99b7b5b3721a.c1b518faff21babf1a9f.js" async=""></script><script src="/_next/static/chunks/5f8a2089eac11fe3b358516a6b612033195d4834.64ceb811d7eabbf018a0.js" async=""></script><script src="/_next/static/chunks/pages/b/%5Bid%5D-eaf8ebe7ceed852553b5.js" async=""></script><script src="/_next/static/6ITGa_4BtWY_kkzQctGtQ/_buildManifest.js" async=""></script><script src="/_next/static/6ITGa_4BtWY_kkzQctGtQ/_ssgManifest.js" async=""></script></body></html>