<!DOCTYPE html><html><head><title>2021-03-08 | te9yie</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="google-site-verification" content="iMWdKZ02K2Yzj9AtOP4cl-40F5DJp-YJLQDzv9vQgMk"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/509606b329852c74360b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/509606b329852c74360b.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-1f0b73d383aed819e4f2.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.3a16fc34825ffc7ba561.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-be08fdd24fededd721c6.js" as="script"/><link rel="preload" href="/_next/static/chunks/7ac61503aba6d10b58e3c266d97d99b7b5b3721a.c1b518faff21babf1a9f.js" as="script"/><link rel="preload" href="/_next/static/chunks/5f8a2089eac11fe3b358516a6b612033195d4834.64ceb811d7eabbf018a0.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/b/%5Bid%5D-eaf8ebe7ceed852553b5.js" as="script"/></head><body><div id="__next"><header><nav><ul><li><a id="site-name" href="/"><h1>te9yie</h1></a></li><li><a href="/b">Blog</a></li><li><a href="/w">Wiki</a></li><li><a href="/search">Search</a></li></ul></nav><h2>2021-03-08</h2></header><article><p><a class="wiki-link" href="/w/Rust">Rust</a>で<a class="wiki-link" href="/w/WebAssembly">WebAssembly</a>を生成しようにも、<a class="wiki-link" href="/w/webpack">webpack</a>の挙動が理解できてなくて意味が分からない。一旦<a class="wiki-link" href="/w/webpack">webpack</a>使わずに、<a class="wiki-link" href="/w/Rust">Rust</a>から<code>wasm</code>を生成し、それを<a class="wiki-link" href="/w/HTML">HTML</a>から読み込むだけのところから始めてみる。</p><p><a class="wiki-link" href="/w/Rust">Rust</a>のクレートとして<code>wasm-bindgen</code>を使う。これは、<a class="wiki-link" href="/w/Rust">Rust</a>と<a class="wiki-link" href="/w/JavaScript">JavaScript</a>の橋渡しをしてくれる。あと<code>web-sys</code>。これを使うと<a class="wiki-link" href="/w/Rust">Rust</a>から<a class="wiki-link" href="/w/DOM">DOM</a>を操作できるようになる。</p><p><code>lib.rs</code>:</p><pre><code class="language-rust">use wasm_bindgen::prelude::*;
use wasm_bindgen::JsCast;

#[wasm_bindgen(start)]
pub fn main() {
    let window = web_sys::window().unwrap();
    let document = window.document().unwrap();
    let canvas = document.get_element_by_id(&quot;canvas&quot;).unwrap();
    let canvas = canvas.dyn_into::&lt;web_sys::HtmlCanvasElement&gt;().unwrap();
    let context = canvas.get_context(&quot;2d&quot;).unwrap();
    let context = context
        .unwrap()
        .dyn_into::&lt;web_sys::CanvasRenderingContext2d&gt;()
        .unwrap();

    context.set_font(&quot;100% sans-serif&quot;);
    context.fill_text(&quot;Hello WASM!&quot;, 10.0, 20.0).unwrap();

    context.set_fill_style(&amp;&quot;red&quot;.into());
    context.fill_rect(20.0, 30.0, 40.0, 40.0);

    context.set_fill_style(&amp;&quot;green&quot;.into());
    context.fill_rect(40.0, 50.0, 40.0, 40.0);
}</code></pre><p><code>Cargo.toml</code>:</p><pre><code class="language-toml">[package]
name = &quot;hello-wasm-canvas&quot;
version = &quot;0.1.0&quot;
authors = [&quot;te9yie &lt;te9yie@users.noreply.github.com&gt;&quot;]
edition = &quot;2018&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
wasm-bindgen = &quot;*&quot;

[dependencies.web-sys]
version = &quot;*&quot;
features = [
    &quot;CanvasRenderingContext2d&quot;,
    &quot;Document&quot;,
    &quot;Element&quot;,
    &quot;HtmlCanvasElement&quot;,
    &quot;Window&quot;,
]</code></pre><p>ビルドしてみる。</p><pre><code class="language-bash">$ wasm-pack build --target web</code></pre><p><code>pkg</code>ディレクトリが生成される。</p><pre><code class="language-bash">pkg
├── hello_wasm_canvas.d.ts
├── hello_wasm_canvas.js
├── hello_wasm_canvas_bg.wasm
├── hello_wasm_canvas_bg.wasm.d.ts
└── package.json</code></pre><p><a class="wiki-link" href="/w/TypeScript">TypeScript</a>用の型情報も生成されるんだな。</p><p>これを読み込む<a class="wiki-link" href="/w/HTML">HTML</a>を書いてみる。</p><p><code>index.html</code>:</p><pre><code class="language-html">&lt;html&gt;
    &lt;body&gt;
        &lt;script type=&quot;module&quot;&gt;
            import init from &quot;./pkg/hello_wasm_canvas.js&quot;;
            const run = async () =&gt; {
                await init();
            }
            run();
        &lt;/script&gt;
        &lt;canvas id=&quot;canvas&quot; /&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><p>適当にサーバを立てて確認してみる。</p><pre><code class="language-bash">$ npx serve</code></pre><p>動いた！</p><p><a class="wiki-link" href="/w/webpack">webpack</a>でこんな感じの<a class="wiki-link" href="/w/HTML">HTML</a>を生成したりしてたんだな。それだけなのになんでバージョン4と5であんなに挙動が変わるんだろう。<a class="wiki-link" href="/w/webpack">webpack</a>の<code>html-webpack-plugin</code>と<code>wasm-pack-plugin</code>あたりを調べてみようか。どうせならバージョン5の方で動かしてみたい。</p></article><footer>© <!-- -->2021<!-- --> <!-- -->te9yie</footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"id":"2021-03-08","content":"[[Rust]]で[[WebAssembly]]を生成しようにも、[[webpack]]の挙動が理解できてなくて意味が分からない。一旦[[webpack]]使わずに、[[Rust]]から`wasm`を生成し、それを[[HTML]]から読み込むだけのところから始めてみる。\n\n[[Rust]]のクレートとして`wasm-bindgen`を使う。これは、[[Rust]]と[[JavaScript]]の橋渡しをしてくれる。あと`web-sys`。これを使うと[[Rust]]から[[DOM]]を操作できるようになる。\n\n`lib.rs`:\n\n```rust\nuse wasm_bindgen::prelude::*;\nuse wasm_bindgen::JsCast;\n\n#[wasm_bindgen(start)]\npub fn main() {\n    let window = web_sys::window().unwrap();\n    let document = window.document().unwrap();\n    let canvas = document.get_element_by_id(\"canvas\").unwrap();\n    let canvas = canvas.dyn_into::\u003cweb_sys::HtmlCanvasElement\u003e().unwrap();\n    let context = canvas.get_context(\"2d\").unwrap();\n    let context = context\n        .unwrap()\n        .dyn_into::\u003cweb_sys::CanvasRenderingContext2d\u003e()\n        .unwrap();\n\n    context.set_font(\"100% sans-serif\");\n    context.fill_text(\"Hello WASM!\", 10.0, 20.0).unwrap();\n\n    context.set_fill_style(\u0026\"red\".into());\n    context.fill_rect(20.0, 30.0, 40.0, 40.0);\n\n    context.set_fill_style(\u0026\"green\".into());\n    context.fill_rect(40.0, 50.0, 40.0, 40.0);\n}\n```\n\n`Cargo.toml`:\n\n```toml\n[package]\nname = \"hello-wasm-canvas\"\nversion = \"0.1.0\"\nauthors = [\"te9yie \u003cte9yie@users.noreply.github.com\u003e\"]\nedition = \"2018\"\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[lib]\ncrate-type = [\"cdylib\"]\n\n[dependencies]\nwasm-bindgen = \"*\"\n\n[dependencies.web-sys]\nversion = \"*\"\nfeatures = [\n    \"CanvasRenderingContext2d\",\n    \"Document\",\n    \"Element\",\n    \"HtmlCanvasElement\",\n    \"Window\",\n]\n```\n\nビルドしてみる。\n\n```bash\n$ wasm-pack build --target web\n```\n\n`pkg`ディレクトリが生成される。\n\n```bash\npkg\n├── hello_wasm_canvas.d.ts\n├── hello_wasm_canvas.js\n├── hello_wasm_canvas_bg.wasm\n├── hello_wasm_canvas_bg.wasm.d.ts\n└── package.json\n```\n\n[[TypeScript]]用の型情報も生成されるんだな。\n\nこれを読み込む[[HTML]]を書いてみる。\n\n`index.html`:\n\n```html\n\u003chtml\u003e\n    \u003cbody\u003e\n        \u003cscript type=\"module\"\u003e\n            import init from \"./pkg/hello_wasm_canvas.js\";\n            const run = async () =\u003e {\n                await init();\n            }\n            run();\n        \u003c/script\u003e\n        \u003ccanvas id=\"canvas\" /\u003e\n    \u003c/body\u003e\n\u003c/html\u003e\n```\n\n適当にサーバを立てて確認してみる。\n\n```bash\n$ npx serve\n```\n\n動いた！\n\n[[webpack]]でこんな感じの[[HTML]]を生成したりしてたんだな。それだけなのになんでバージョン4と5であんなに挙動が変わるんだろう。[[webpack]]の`html-webpack-plugin`と`wasm-pack-plugin`あたりを調べてみようか。どうせならバージョン5の方で動かしてみたい。\n"}},"__N_SSG":true},"page":"/b/[id]","query":{"id":"2021-03-08"},"buildId":"6ITGa_4BtWY_kkzQctGtQ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-4f4acd756cef4fe6da1b.js"></script><script src="/_next/static/chunks/main-1f0b73d383aed819e4f2.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" async=""></script><script src="/_next/static/chunks/commons.3a16fc34825ffc7ba561.js" async=""></script><script src="/_next/static/chunks/pages/_app-be08fdd24fededd721c6.js" async=""></script><script src="/_next/static/chunks/7ac61503aba6d10b58e3c266d97d99b7b5b3721a.c1b518faff21babf1a9f.js" async=""></script><script src="/_next/static/chunks/5f8a2089eac11fe3b358516a6b612033195d4834.64ceb811d7eabbf018a0.js" async=""></script><script src="/_next/static/chunks/pages/b/%5Bid%5D-eaf8ebe7ceed852553b5.js" async=""></script><script src="/_next/static/6ITGa_4BtWY_kkzQctGtQ/_buildManifest.js" async=""></script><script src="/_next/static/6ITGa_4BtWY_kkzQctGtQ/_ssgManifest.js" async=""></script></body></html>