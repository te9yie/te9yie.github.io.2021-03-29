[[Rust]]ã‹ã‚‰[[WebAssembly]]ã‚’ä½œã£ã¦ã¿ã‚‹ã€‚

[Hello, World! - The `wasm-bindgen` Guide](https://rustwasm.github.io/docs/wasm-bindgen/examples/hello-world.html)ã‚’å‚è€ƒã«ã‚„ã£ã¦ã¿ãŸã‚“ã ã‘ã©ã€è‰²ã€…ä¸Šæ‰‹ãå‹•ã‹ãªã‹ã£ãŸã€‚

```bash
$ cargo new hello-wasm --lib
$ cd hello-wasm
$ yarn init -y
$ yarn add -D @wasm-tool/wasm-pack-plugin text-encoding html-webpack-plugin webpack webpack-cli webpack-dev-server
$ code . # ã‚µãƒ³ãƒ—ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«è‰²ã€…æ›¸ã
$ yarn build
```

ã“ã“ã§ã‚¨ãƒ©ãƒ¼

```bash
yarn run v1.22.10
$ webpack
ğŸ§  Checking for wasm-pack...

â„¹ï¸  Installing wasm-pack 

[webpack-cli] Error: Rust compilation.
    at ChildProcess.p.on.code (/home/i/w/hello-wasm/node_modules/@wasm-tool/wasm-pack-plugin/plugin.js:221:16)
    at ChildProcess.emit (events.js:198:13)
    at maybeClose (internal/child_process.js:982:16)
    at Socket.stream.socket.on (internal/child_process.js:389:11)
    at Socket.emit (events.js:198:13)
    at Pipe._handle.close (net.js:607:12)
error Command failed with exit code 2.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```

`cargo build`ã¯å•é¡Œãªãã¦`$(npm bin)/webpack`ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚
`wasm-pack-plugin`ã£ã¦ã®ã§ã‚³ã‚±ã¦ãã†ã ã£ãŸã®ã§ã€[wasm-tool/wasm-pack-plugin: webpack plugin for Rust](https://github.com/wasm-tool/wasm-pack-plugin)ã‚’è¦‹ã«è¡Œã£ãŸã‚‰ã€`wasm-pack`ã‚’å…¥ã‚Œã‚ã£ã¦æ›¸ã„ã¦ã‚ã£ãŸã€‚ã‚ˆãè¦‹ã‚‹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚‚`Installing wasm-pack`ã£ã¦å‡ºã¦ãŸã€‚

```bash
$ cargo install wasm-pack
$ yarn build
```

ã¾ãŸã‚¨ãƒ©ãƒ¼

```bash
yarn run v1.22.10
$ webpack
ğŸ§  Checking for wasm-pack...

âœ…  wasm-pack is installed at /home/i/.cargo/bin/wasm-pack. 

â„¹ï¸  Compiling your crate in development mode...

[INFO]: Checking for the Wasm target...
[INFO]: Compiling to Wasm...
   Compiling cfg-if v1.0.0
   Compiling wasm-bindgen v0.2.71
   Compiling hello-wasm v0.1.0 (/home/i/w/hello-wasm)
    Finished dev [unoptimized + debuginfo] target(s) in 0.83s
:-) [WARN]: origin crate has no README
[INFO]: Installing wasm-bindgen...
[INFO]: Optional fields missing from Cargo.toml: 'description', 'repository', and 'license'. These are not necessary, but recommended
[INFO]: :-) Done in 1.06s
[INFO]: :-) Your wasm pkg is ready to publish at /home/i/w/hello-wasm/pkg.
âœ…  Your crate has been correctly compiled

asset vendors-node_modules_text-encoding_index_js.index.js 623 KiB [emitted] (id hint: vendors)
asset index.js 13.3 KiB [emitted] (name: main)
asset pkg_index_js.index.js 7.28 KiB [emitted]
asset index.html 232 bytes [emitted]
runtime modules 7.32 KiB 11 modules
cacheable modules 692 KiB
  modules by path ./pkg/ 74.7 KiB
    ./pkg/index.js 71 bytes [built] [code generated]
    ./pkg/index_bg.js 3.25 KiB [built] [code generated]
    ./pkg/index_bg.wasm 71.4 KiB [built] [code generated] [1 error]
  modules by path ./node_modules/text-encoding/ 617 KiB
    ./node_modules/text-encoding/index.js 258 bytes [built] [code generated]
    ./node_modules/text-encoding/lib/encoding.js 99.1 KiB [built] [code generated]
    ./node_modules/text-encoding/lib/encoding-indexes.js 518 KiB [built] [code generated]
  ./index.js 88 bytes [built] [code generated]

ERROR in ./pkg/index_bg.wasm 1:0
Module parse failed: Unexpected character '' (1:0)
The module seem to be a WebAssembly module, but module is not flagged as WebAssembly module for webpack.
BREAKING CHANGE: Since webpack 5 WebAssembly is not enabled by default and flagged as experimental feature.
You need to enable one of the WebAssembly experiments via 'experiments.asyncWebAssembly: true' (based on async modules) or 'experiments.syncWebAssembly: true' (like webpack 4, deprecated).
For files that transpile to WebAssembly, make sure to set the module type in the 'module.rules' section of the config (e. g. 'type: "webassembly/async"').
(Source code omitted for this binary file)
 @ ./pkg/index.js 1:0-40
 @ ./index.js 1:13-28

webpack 5.24.3 compiled with 1 error in 1526 ms
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```

`experiments.asyncWebAssembly: true`ã«ã—ã¦`module.rules`ã‚’è¨­å®šã—ã‚ã¨ã®ã“ã¨ãªã®ã§`webpack.config.js`ã‚’ä¿®æ­£ã—ãŸã€‚

```diff
+  experiments: {
+    asyncWebAssembly: true,
+  },
+  module: {
+    rules: [
+      {
+        test: /\.wasm/,
+        type: "webassembly/async",
+      },
+    ],
+  },
```

`yarn build`ãŒé€šã£ãŸã®ã§`yarn serve`ã—ã¦ã¿ã‚‹ã€‚ã‚¨ãƒ©ãƒ¼ã€‚

```bash
$ yarn serve
yarn run v1.22.10
$ webpack-dev-server
internal/modules/cjs/loader.js:638
    throw err;
    ^

Error: Cannot find module 'webpack-cli/bin/config-yargs'
    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:636:15)
    at Function.Module._load (internal/modules/cjs/loader.js:562:25)
    at Module.require (internal/modules/cjs/loader.js:692:17)
    at require (internal/modules/cjs/helpers.js:25:18)
    at Object.<anonymous> (/home/i/w/hello-wasm/node_modules/webpack-dev-server/bin/webpack-dev-server.js:65:1)
    at Module._compile (internal/modules/cjs/loader.js:778:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:789:10)
    at Module.load (internal/modules/cjs/loader.js:653:32)
    at tryModuleLoad (internal/modules/cjs/loader.js:593:12)
    at Function.Module._load (internal/modules/cjs/loader.js:585:3)
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```

[webpackã§Webã‚µãƒ¼ãƒãƒ¼ã§ã®ç¢ºèªã«webpack-dev-serverã¯ä¸å¯ | iwb.jp](https://iwb.jp/webpack-cli-dev-server-error-config-yargs/)ã§ã€`webpack-cli serve`ã‚’ä½¿ãˆã¨ã®ã“ã¨ãªã®ã§ã€ä¿®æ­£ã—ã¦ã¿ã‚‹ã€‚

```diff
-    "serve": "webpack-dev-server"
+    "serve": "webpack-cli serve --open --mode development"
```

ã‚¨ãƒ©ãƒ¼ãªãå‹•ã„ãŸã€‚ãŒã€ä½•ã‚‚èµ·ããªã„ã€‚ã©ã†ãªã£ã¦ã‚“ã ï¼Ÿã¨æ€ã£ã¦ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’è¦‹ãŸã‚‰ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ãŸã€‚

```
TypeError: Cannot read property '__wbindgen_malloc' of undefined
    at Module.greet (index_bg.js:115)
    at eval (index.js:4)
```

â€¦ç„¡ç†ã€‚ã‚‚ã†åˆ†ã‹ã‚“ãªã„ã€‚
ãã‚‚ãã‚‚ã‚µãƒ³ãƒ—ãƒ«å‹•ãã‚“ã‹ã‚ˆã€‚ã¨æ€ã£ã¦

https://github.com/rustwasm/wasm-bindgen/tree/master/examples/hello_world

ã‚’è©¦ã—ãŸã‚‰å‹•ã„ãŸã€‚
ä½•ãŒé•ã†ã‚“ã ã¨æ€ã£ã¦ã‚ˆãè¦‹æ¯”ã¹ã‚‹ã¨`package.json`ãŒé•ã£ãŸã€‚

```diff
-    "html-webpack-plugin": "^5.2.0",
-    "webpack": "^5.24.3",
-    "webpack-cli": "^4.5.0",
-    "webpack-dev-server": "^3.11.2"
+    "html-webpack-plugin": "^3.2.0",
+    "webpack": "^4.29.4",
+    "webpack-cli": "^3.1.1",
+    "webpack-dev-server": "^3.1.0"
```

ã•ã£ãã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚‚å¤§ä½“[[webpack]]ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ4ã˜ã‚ƒãªãã¦5ã ã‹ã‚‰å‡ºã¦ã‚‹é›°å›²æ°—ã‚’é†¸ã—å‡ºã—ã¦ã„ãŸã€‚ãªã‚“ã§ã‚‚æœ€æ–°ã˜ã‚ƒã ã‚ãªã‚“ã ã­ã‡ã€‚

ã¨ã‚Šã‚ãˆãš[[webpack]]ã‚ãŸã‚Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’4ã«ã—ã¦ã¿ã‚‹ã€‚

```diff
-    "html-webpack-plugin": "^5.2.0",
-    "webpack": "^5.24.3",
+    "html-webpack-plugin": "^4.0.0",
+    "webpack": "^4.0.0",
```

å‹•ã„ãŸã€‚

### ã¾ã¨ã‚

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆã‚ã›ã‚‹ã®å¤§äº‹ï¼ï¼ï¼
